# drivers

本目录包含用于 **脉冲模式伺服控制与雷达同步** 的底层驱动模块。  
整体设计目标是：**在不同频率区间内，使用最合适的硬件后端，以保证时序确定性与工程可靠性**。

---

## ps100

`ps100` 模块对 **PS100 系列伺服驱动器的脉冲控制模式**进行抽象，  
并统一管理 **PWM / PIO 两种后端**，为上层提供一致的运动控制接口。

### 功能概述

- 抽象 STEP / DIR / ENABLE 接口
- 支持：
  - 固定步数运动（`run_steps`）
  - 定速运动（`run_velocity`）
  - PIO 流式控制（`run_pio_stream`）
- 与雷达同步系统（`radar_sync` PIO 程序）协同工作

### 后端架构

`ps100` 根据命令类型与频率要求，选择不同的硬件后端。

#### 1. PWM backend

- 基于 RP2040 硬件 PWM
- 适用于：
  - 低频 / 中频
  - 配置简单
  - 非关键同步场景
- **有效频率范围（工程实测稳定）**：

~8Hz - ~220kHz


- 限制：
- 依赖 PWM wrap IRQ 进行计步
- 高频下 IRQ 负载过大，无法保证步数精度

#### 2. PIO backend（参数 / 流式）

- 基于 RP2040 PIO
- 适用于：
- 高频脉冲
- 精确计步
- 雷达同步等强时序场景
- **工程可依赖的频率能力**：


- 特点：
- 不依赖 CPU / IRQ
- 时序确定
- 抖动 ≤ 1–2 PIO cycles
- 结构性约束：
- 单 SM 在执行雷达触发等操作时存在“忙碌盲区”
- 该盲区已被定量分析，并保证实际应用频率远低于其极限

### 设计结论（重要）

- PWM backend **不用于高频计步**
- 高频、强同步、精确计数 **必须使用 PIO**
- 当前系统配置下（1500 rpm，电子齿轮比 32767）：

最大 STEP 频率 ≈ 0.82 MHz


该频率：
- 超出 PWM 能力范围
- 明显低于 PIO 的安全工作上限  
⇒ **PIO backend 具备充足工程余量**

---

## pwm_motor

`pwm_motor` 模块为上层提供**最小、直接的 PWM 控制接口**，  
不承担高频计步或强实时同步职责。

### 功能概述

- 封装 RP2040 硬件 PWM
- 支持：
- 设定输出频率
- 输出固定步数的脉冲
- 内部通过 PWM wrap IRQ 进行步数递减

### 设计定位

`pwm_motor` 的设计目标是：

**简单、稳定、低负担**  而不是极限性能

### 有效频率范围（工程实测）

~8 Hz ≤ f ≤ ~220 kHz


- 下限由 wrap / clk_div 分辨率决定
- 上限由 IRQ 负载与中断抖动决定
- 超过 ~220 kHz：
  - PWM 仍可能输出波形
  - 但步数统计不再可靠

### 使用约束（必须遵守）

- 不用于：
  - 高频脉冲计步
  - 雷达同步
  - 精确停止在 N 步
- 适用于：
  - 低速调试
  - 简单运动
  - 非关键路径控制

---

## 模块协作原则（总结）

| 场景 | 推荐模块 |
|----|----|
| 低频 / 调试 / 简单控制 | `pwm_motor` |
| 高频脉冲 / 精确计步 | `ps100 + PIO backend` |
| 雷达同步 / 强时序 | `ps100 + radar_sync (PIO)` |

---

## 注意

- **不要用 IRQ 去做 MHz 级事情**
- **不要用 PWM 去承担强同步语义**
- **PIO 是 RP2040 上唯一可靠的 MHz 级时序工具**
